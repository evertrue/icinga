#!/usr/bin/php5
<?php
/**
 * flexible notifications by sms
 * @author nbartels
 **/

$smsUser = '<%= @node['check_mk']['notifications']['smsUser'] %>';
$smsPassword = '<%= @node['check_mk']['notifications']['smsPassword'] %>';
$pagerNumber = getenv('NOTIFY_CONTACTPAGER');

$hostName = getenv('NOTIFY_HOSTNAME');
$hostState = getenv('NOTIFY_HOSTSTATE');
$hostCommand = getenv('NOTIFY_HOSTCHECKCOMMAND');
$serviceState = getenv('NOTIFY_SERVICESTATE');
$serviceCommand = getenv('NOTIFY_SERVICECHECKCOMMAND');
$serviceDesc = getenv('NOTIFY_SERVICEDESC');

$content = $hostName . ': ' . $hostCommand . ' -> ' . $hostState . ' | ' . $serviceCommand . ' (' . $serviceDesc . ') -> ' . $serviceState;

$smsGatewayUrl = 'http://gateway.smskaufen.de/?id='.$smsUser.'&pw='.$smsPassword.'&empfaenger='.urlencode($pagerNumber).'&absender=monitoring&type=4&text='.urlencode($content);

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $smsGatewayUrl);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
curl_setopt($ch, CURLOPT_MAXREDIRS, 10);
curl_setopt($ch, CURLOPT_TIMEOUT, 15);
$res = curl_exec($ch);
curl_close($ch);
